<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Читалка</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
/* ===== ОБЩЕЕ ===== */
body {
  margin:0;
  background:#111;        /* тёмный фон вокруг книги */
  color:#fff;
  font-family:sans-serif;
  text-align:center;
}

.hidden { display:none; }

/* контейнер книги */
#pdf {
  display:flex;
  flex-direction:column;
  align-items:center;     /* ЦЕНТРИРУЕМ СТРАНИЦЫ */
}

/* canvas = СТРАНИЦА */
canvas {
  display:block;
  background:#fff;        /* ТОЛЬКО СТРАНИЦА БЕЛАЯ */
}

/* ===== РАЗВОРОТ ===== */
.spread {
  display:flex;
  justify-content:center;
  gap:2px;                /* микрозазор, стабильный */
  background:transparent;/* УБРАЛИ БЕЛУЮ ПОДЛОЖКУ */
  margin-bottom:32px;
}

/* мобилка — одна страница */
.mobile .spread {
  flex-direction:column;
  gap:0;
}

/* ===== ЗУМ ===== */
.zoomControls {
  position:fixed;
  right:16px;
  bottom:16px;
  z-index:999;
}
.zoomControls button {
  font-size:22px;
  padding:12px 16px;
  margin:4px;
}

/* ===== АДМИНКА ===== */
.adminUser {
  border:1px solid #444;
  margin:6px;
  padding:6px;
  text-align:left;
}
.warn { color:#ff5555; }
</style>
</head>

<body>

<h2 id="title">Вход</h2>

<!-- LOGIN -->
<div id="loginBox">
  <input id="email" placeholder="email"><br>
  <input id="password" type="password" placeholder="пароль"><br>
  <button onclick="login()">Войти</button>
</div>

<!-- ADMIN -->
<div id="adminBox" class="hidden">
  <h3>Админка</h3>
  <div id="userList"></div>
</div>

<!-- READER -->
<div id="readerBox" class="hidden">
  <div id="pdf"></div>
</div>

<!-- ZOOM -->
<div class="zoomControls hidden" id="zoomControls">
  <button onclick="changeZoom(0.2)">+</button>
  <button onclick="changeZoom(-0.2)">−</button>
</div>

<script>
/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey: "AIzaSyBI_MW2hD1k5ORHZF_56zVzJvelHSVnvko",
  authDomain: "book-aed2c.firebaseapp.com",
  projectId: "book-aed2c"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* ===== STATE ===== */
const isMobile = window.innerWidth < 700;
if (isMobile) document.body.classList.add("mobile");

let SCALE = isMobile ? 1.2 : 1.8;
let pdfDoc = null;
let zoomTimer = null;

/* ===== LOGIN ===== */
function login() {
  auth.signInWithEmailAndPassword(email.value, password.value)
    .then(afterLogin)
    .catch(() => alert("Неверный логин или пароль"));
}

async function afterLogin() {
  const user = auth.currentUser;
  const ref = db.collection("users").doc(user.email);
  const snap = await ref.get();

  if (!snap.exists) {
    await ref.set({ role:"user", logins:0 });
  }

  const data = (await ref.get()).data();

  loginBox.classList.add("hidden");
  readerBox.classList.remove("hidden");
  zoomControls.classList.remove("hidden");
  title.innerText = "Читалка";

  if (data.role === "admin") {
    adminBox.classList.remove("hidden");
    loadUsers();              // ← ВАЖНО: ВОЗВРАЩЕНО
  }

  loadPDF();
}

/* ===== PDF ===== */
function loadPDF() {
  pdfjsLib.getDocument("book.pdf").promise.then(pdf => {
    pdfDoc = pdf;
    renderAll();
  });
}

function renderAll() {
  const box = document.getElementById("pdf");
  box.innerHTML = "";

  for (let i = 1; i <= pdfDoc.numPages; i++) {
    renderPage(i);
  }
}

function renderPage(num) {
  pdfDoc.getPage(num).then(page => {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    const dpr = window.devicePixelRatio || 1;
    const viewport = page.getViewport({ scale: SCALE });

    canvas.width = viewport.width * dpr;
    canvas.height = viewport.height * dpr;
    canvas.style.width = viewport.width + "px";
    canvas.style.height = viewport.height + "px";

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    page.render({ canvasContext: ctx, viewport });

    if (isMobile || num === 1) {
      document.getElementById("pdf").appendChild(canvas);
    } else {
      let last = document.querySelector(".spread:last-child");
      if (!last || last.children.length === 2) {
        last = document.createElement("div");
        last.className = "spread";
        document.getElementById("pdf").appendChild(last);
      }
      last.appendChild(canvas);
    }
  });
}

/* ===== ZOOM (DEBOUNCE) ===== */
function changeZoom(delta) {
  SCALE = Math.max(0.8, SCALE + delta);

  clearTimeout(zoomTimer);
  zoomTimer = setTimeout(() => {
    renderAll();
  }, 250);
}

/* ===== ADMIN ===== */
async function loadUsers() {
  const snap = await db.collection("users").get();
  const box = document.getElementById("userList");
  box.innerHTML = "";

  snap.forEach(doc => {
    const d = doc.data();
    box.innerHTML += `
      <div class="adminUser">
        <b>${doc.id}</b><br>
        Входов: ${d.logins || 0}
      </div>
    `;
  });
}
</script>

</body>
</html>
