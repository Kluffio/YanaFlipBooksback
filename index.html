<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Corporate Library</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        /* –°–¢–ò–õ–ò */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; touch-action: manipulation; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #121212; color: #eee; height: 100vh; overflow: hidden; }
        
        .screen { display: none; height: 100%; width: 100%; position: absolute; top: 0; left: 0; flex-direction: column; }
        .active { display: flex; }

        /* –í–•–û–î */
        .login-container { align-items: center; justify-content: center; background: #000; }
        .login-box { background: #1e1e1e; padding: 30px; border-radius: 12px; width: 90%; max-width: 350px; text-align: center; border: 1px solid #333; }
        input { width: 100%; padding: 14px; margin: 8px 0; background: #333; border: 1px solid #444; color: white; border-radius: 8px; outline: none; font-size: 16px; }
        .btn { width: 100%; padding: 14px; margin-top: 15px; background: #007AFF; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.3s; }
        .btn:disabled { background: #555; cursor: not-allowed; }
        .error-msg { color: #ff453a; font-size: 14px; margin-top: 15px; min-height: 20px; }

        /* –ß–ò–¢–ê–õ–ö–ê */
        .reader-container { background: #000; position: relative; }
        .viewport { flex: 1; overflow: auto; display: flex; justify-content: center; align-items: flex-start; padding: 10px; -webkit-overflow-scrolling: touch; }
        canvas { display: block; max-width: 100%; height: auto !important; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .toolbar { background: #1c1c1e; border-top: 1px solid #333; padding: 10px 15px; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        .ctrl-group { display: flex; gap: 15px; align-items: center; }
        .tool-btn { background: #333; color: #fff; border: none; width: 44px; height: 44px; border-radius: 50%; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .page-info { font-family: monospace; color: #888; font-size: 14px; min-width: 60px; text-align: center; }
        
        /* –ó–ê–ì–†–£–ó–ß–ò–ö */
        .loader-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .progress-bar-bg { width: 80%; height: 4px; background: #333; border-radius: 2px; margin-top: 20px; }
        .progress-bar-fill { width: 0%; height: 100%; background: #007AFF; transition: width 0.2s; }
    </style>
</head>
<body>

    <!-- –í–•–û–î -->
    <div id="loginScreen" class="screen active login-container">
        <div class="login-box">
            <h2 style="color:#fff; margin-bottom:20px;">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h2>
            <input type="text" id="loginUser" placeholder="–õ–æ–≥–∏–Ω" autocapitalize="none">
            <input type="password" id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn" id="loginBtn" onclick="handleLogin()">–í–æ–π—Ç–∏</button>
            <div class="error-msg" id="loginError"></div>
        </div>
    </div>

    <!-- –ß–ò–¢–ê–õ–ö–ê -->
    <div id="readerScreen" class="screen reader-container">
        <div class="viewport" id="viewport">
            <div id="loader" class="loader-overlay" style="display: none;">
                <div id="loaderText" style="color:#ccc">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressBar"></div></div>
            </div>
            <canvas id="pdfCanvas"></canvas>
        </div>
        <div class="toolbar">
            <div class="ctrl-group">
                <button class="tool-btn" onclick="changePage(-1)">‚óÄ</button>
                <span class="page-info" id="pageInfo">0/0</span>
                <button class="tool-btn" onclick="changePage(1)">‚ñ∂</button>
            </div>
            <div class="ctrl-group">
                <button class="tool-btn" onclick="zoom(-0.2)">‚àí</button>
                <button class="tool-btn" onclick="zoom(0.2)">+</button>
                <button class="tool-btn" style="background:#ff453a" onclick="logout()">‚úï</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // –ù–ê–°–¢–†–û–ô–ö–ò 
        // ==========================================
        
        // –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å—Å—ã–ª–∫—É –∏–∑ Google Apps Script (–∫–æ—Ç–æ—Ä–∞—è –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ /exec)
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby7WCduakFRoipv2nOY2f93txxy5oKuQoKZzsZLNvtaBhJpqmXAbNekcCtCLKw6Guh18Q/exec';
        
        // –¢–µ–ª–µ–≥—Ä–∞–º (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω —à–ø–∏–æ–Ω–∞–∂)
        const TG_TOKEN = '–¢–û–ö–ï–ù_–ë–û–¢–ê'; 
        const TG_CHAT_ID = '–¢–í–û–ô_ID';

        const FILE_NAME = 'system_core.dat'; 
        // ==========================================

        let pdfDoc = null;
        let pageNum = 1;
        let scale = 1.0;
        let touchStartX = 0;
        let touchEndX = 0;

        window.onload = () => {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            if(localStorage.getItem('session') === 'active') {
                showScreen('readerScreen');
                loadBook();
            }
            setupSwipe();
        };

        // === –í–•–û–î –ß–ï–†–ï–ó GOOGLE –¢–ê–ë–õ–ò–¶–£ ===
        async function handleLogin() {
            const l = document.getElementById('loginUser').value.trim();
            const p = document.getElementById('loginPass').value.trim();
            const btn = document.getElementById('loginBtn');
            const err = document.getElementById('loginError');

            if(!l || !p) return;

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            btn.disabled = true;
            btn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
            err.textContent = '';

            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ Google –¢–∞–±–ª–∏—Ü—É
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?login=${encodeURIComponent(l)}&pass=${encodeURIComponent(p)}`);
                const result = await response.text();

                if (result.includes("SUCCESS")) {
                    // –£—Å–ø–µ—Ö
                    localStorage.setItem('session', 'active');
                    showScreen('readerScreen');
                    loadBook();
                    sendTelegramLog(l); // –®–ª–µ–º –æ—Ç—á–µ—Ç –≤ –¢–ì
                } else {
                    err.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                    btn.disabled = false;
                    btn.textContent = '–í–æ–π—Ç–∏';
                }
            } catch (e) {
                console.error(e);
                // –ï—Å–ª–∏ Google –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏
                err.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.';
                btn.disabled = false;
                btn.textContent = '–í–æ–π—Ç–∏';
            }
        }

        function logout() { localStorage.removeItem('session'); location.reload(); }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // === –®–ü–ò–û–ù–°–ö–ò–ô –ú–û–î–£–õ–¨ (–¢–ï–õ–ï–ì–†–ê–ú) ===
        async function sendTelegramLog(username) {
            if (!TG_TOKEN || TG_TOKEN.includes('–¢–û–ö–ï–ù')) return;
            let ip = '...';
            try { const r = await fetch('https://api.ipify.org?format=json'); const d = await r.json(); ip = d.ip; } catch(e){}
            
            let deviceId = localStorage.getItem('did');
            if (!deviceId) { deviceId = Math.random().toString(36).slice(2); localStorage.setItem('did', deviceId); }

            const ua = navigator.userAgent;
            let dev = /Android/i.test(ua) ? "Android" : /iPhone|iPad/i.test(ua) ? "iOS" : "PC";

            const msg = `üö® <b>–í—Ö–æ–¥!</b>\nüë§: <b>${username}</b>\nüì±: ${dev}\nüåê: ${ip}\nüîë ID: <code>${deviceId}</code>`;
            fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ chat_id: TG_CHAT_ID, text: msg, parse_mode: 'HTML' })
            });
        }

        // === –ß–ò–¢–ê–õ–ö–ê ===
        async function loadBook() {
            if (pdfDoc) return;
            const loader = document.getElementById('loader');
            const bar = document.getElementById('progressBar');
            loader.style.display = 'flex';
            try {
                const response = await fetch(FILE_NAME);
                if (!response.ok) throw new Error('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
                const total = parseInt(response.headers.get('content-length'), 10);
                let loaded = 0;
                const reader = response.body.getReader();
                const chunks = [];
                while(true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    loaded += value.length;
                    if(total) bar.style.width = Math.round((loaded/total)*100) + '%';
                }
                const blob = new Blob(chunks, {type: 'application/pdf'});
                const url = URL.createObjectURL(blob);
                const task = pdfjsLib.getDocument(url);
                pdfDoc = await task.promise;
                URL.revokeObjectURL(url);
                loader.style.display = 'none';
                fitToScreen();
            } catch (e) { alert('–û—à–∏–±–∫–∞: ' + e.message); }
        }

        function fitToScreen() {
            if (!pdfDoc) return;
            pdfDoc.getPage(1).then(page => {
                const viewport = page.getViewport({scale: 1.0});
                const containerWidth = document.getElementById('viewport').clientWidth;
                scale = (containerWidth / viewport.width) * 0.95;
                renderPage(pageNum);
            });
        }

        let renderTask = null;
        function renderPage(num) {
            if (renderTask) renderTask.cancel();
            pdfDoc.getPage(num).then(page => {
                const canvas = document.getElementById('pdfCanvas');
                const ctx = canvas.getContext('2d');
                const pixelRatio = window.devicePixelRatio || 1;
                const viewport = page.getViewport({ scale: scale * pixelRatio });
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                canvas.style.width = `${viewport.width / pixelRatio}px`;
                canvas.style.height = `${viewport.height / pixelRatio}px`;
                const renderContext = { canvasContext: ctx, viewport: viewport, transform: [pixelRatio, 0, 0, pixelRatio, 0, 0] };
                renderTask = page.render(renderContext);
                renderTask.promise.then(() => document.getElementById('pageInfo').textContent = `${num}/${pdfDoc.numPages}`);
            });
        }
        function changePage(d) {
            if (!pdfDoc) return;
            const newPage = pageNum + d;
            if (newPage >= 1 && newPage <= pdfDoc.numPages) {
                pageNum = newPage;
                renderPage(pageNum);
                document.getElementById('viewport').scrollTop = 0;
            }
        }
        function zoom(d) { scale += d; if (scale < 0.2) scale = 0.2; renderPage(pageNum); }
        function setupSwipe() {
            const view = document.getElementById('viewport');
            view.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; });
            view.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); });
        }
        function handleSwipe() {
            if (touchEndX < touchStartX - 50) changePage(1);
            if (touchEndX > touchStartX + 50) changePage(-1);
        }
        document.addEventListener('contextmenu', e => e.preventDefault());
    </script>
</body>
</html>