<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Corporate Library</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        /* === –°–¢–ò–õ–ò === */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #eee; height: 100vh; overflow: hidden; }
        
        /* –°–ò–°–¢–ï–ú–ê –≠–ö–†–ê–ù–û–í */
        .screen { display: none; height: 100%; width: 100%; position: absolute; top: 0; left: 0; flex-direction: column; }
        .active { display: flex; }

        /* –≠–ö–†–ê–ù –í–•–û–î–ê */
        .login-container { align-items: center; justify-content: center; background: radial-gradient(circle at center, #1e272e 0%, #000000 100%); }
        .login-box {
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px);
            padding: 40px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);
            width: 320px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .login-box h2 { margin-bottom: 20px; font-weight: 300; letter-spacing: 1px; color: #fff; }
        input {
            width: 100%; padding: 12px; margin: 10px 0;
            background: rgba(0,0,0,0.4); border: 1px solid #444;
            color: white; border-radius: 8px; outline: none; transition: 0.3s;
        }
        input:focus { border-color: #3498db; background: rgba(0,0,0,0.6); }
        .btn {
            width: 100%; padding: 12px; margin-top: 15px;
            background: #3498db; color: white; border: none;
            border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;
            transition: 0.2s;
        }
        .btn:hover { background: #2980b9; transform: translateY(-1px); }
        .error-msg { color: #ff6b6b; font-size: 13px; margin-top: 15px; min-height: 18px; }

        /* –ê–î–ú–ò–ù–ö–ê */
        .admin-panel { background: #1a1a1a; padding: 20px; overflow-y: auto; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .card { background: #252525; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .user-list { max-height: 400px; overflow-y: auto; margin-top: 15px; }
        .user-item { 
            display: flex; justify-content: space-between; align-items: center;
            background: #333; padding: 12px; margin-bottom: 8px; border-radius: 6px; 
        }
        .del-btn { background: #e74c3c; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 0; width: auto; }

        /* –ß–ò–¢–ê–õ–ö–ê */
        .reader-container { background: #000; }
        .toolbar {
            height: 50px; background: #252525; border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: center; gap: 15px; z-index: 10;
        }
        .tool-btn { background: transparent; border: 1px solid #444; color: #ccc; padding: 6px 14px; border-radius: 4px; cursor: pointer; }
        .tool-btn:hover { background: #333; color: white; }
        .page-info { font-family: monospace; color: #888; font-size: 14px; }
        .viewport { flex: 1; overflow: auto; display: flex; justify-content: center; padding: 20px; position: relative; }
        canvas { box-shadow: 0 0 40px rgba(0,0,0,0.5); display: block; max-width: 100%; }

        /* –ó–ê–ì–†–£–ó–ß–ò–ö */
        .loader-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #121212; z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .progress-container { width: 300px; height: 6px; background: #333; margin-top: 20px; border-radius: 3px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: #3498db; transition: width 0.2s; }
        .logout-btn-small { background: #c0392b; font-size: 12px; padding: 5px 10px; border-radius: 4px; color: white; border: none; cursor: pointer; position: absolute; right: 20px; }
    </style>
</head>
<body>

    <!-- 1. –í–•–û–î -->
    <div id="loginScreen" class="screen active login-container">
        <div class="login-box">
            <h2>üîí –í—Ö–æ–¥</h2>
            <input type="text" id="loginUser" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn" onclick="handleLogin()">–í–æ–π—Ç–∏</button>
            <div class="error-msg" id="loginError"></div>
        </div>
    </div>

    <!-- 2. –ê–î–ú–ò–ù–ö–ê -->
    <div id="adminScreen" class="screen admin-panel">
        <div class="admin-header">
            <h2>‚öôÔ∏è –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
            <button class="logout-btn-small" style="position: static;" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 15px; color: #ddd;">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h3>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="newLogin" placeholder="–õ–æ–≥–∏–Ω" style="margin: 0;">
                <input type="text" id="newPass" placeholder="–ü–∞—Ä–æ–ª—å" style="margin: 0;">
            </div>
            <button class="btn" style="margin-top: 10px;" onclick="addUser()">–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 15px; color: #ddd;">–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
            <div id="userList" class="user-list"></div>
        </div>
    </div>

    <!-- 3. –ß–ò–¢–ê–õ–ö–ê -->
    <div id="readerScreen" class="screen reader-container">
        <div class="toolbar">
            <button class="tool-btn" onclick="changePage(-1)">‚óÄ</button>
            <span class="page-info" id="pageInfo">0 / 0</span>
            <button class="tool-btn" onclick="changePage(1)">‚ñ∂</button>
            <div style="width:1px; height:20px; background:#444"></div>
            <button class="tool-btn" onclick="zoom(0.2)">+</button>
            <button class="tool-btn" onclick="zoom(-0.2)">-</button>
            <button class="logout-btn-small" onclick="logout()">–í—ã—Ö–æ–¥</button>
        </div>

        <div class="viewport" id="viewport">
            <div id="loader" class="loader-overlay" style="display: none;">
                <div id="loaderText" style="color: #ccc; margin-bottom: 10px;">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥–∏...</div>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>
            <canvas id="pdfCanvas"></canvas>
        </div>
    </div>

    <script>
        // === –ù–ê–°–¢–†–û–ô–ö–ò –ê–î–ú–ò–ù–ê ===
        const ADMIN_LOGIN = 'admin';
        const ADMIN_PASS = '123';
        
        // –ò–ú–Ø –§–ê–ô–õ–ê –ö–ù–ò–ì–ò (–¥–æ–ª–∂–µ–Ω –ª–µ–∂–∞—Ç—å —Ä—è–¥–æ–º —Å index.html)
        const FILE_NAME = 'system_core.dat'; 

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        let pdfDoc = null;
        let pageNum = 1;
        let scale = 1.0;
        let renderTask = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = () => {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            checkSession();
        };

        // === –õ–û–ì–ò–ö–ê –í–•–û–î–ê ===
        function handleLogin() {
            const l = document.getElementById('loginUser').value.trim();
            const p = document.getElementById('loginPass').value.trim();
            const err = document.getElementById('loginError');

            if (!l || !p) { err.textContent = '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å'; return; }

            // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞
            if (l === ADMIN_LOGIN && p === ADMIN_PASS) {
                localStorage.setItem('session', 'admin');
                showScreen('adminScreen');
                renderUserList();
                return;
            }

            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const users = getUsers();
            const user = users.find(u => u.login === l && u.pass === p);

            if (user) {
                localStorage.setItem('session', 'user');
                showScreen('readerScreen');
                loadBook(); // –ó–ê–ü–£–°–ö –ó–ê–ì–†–£–ó–ö–ò
            } else {
                err.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
            }
        }

        function logout() {
            localStorage.removeItem('session');
            location.reload();
        }

        function checkSession() {
            const s = localStorage.getItem('session');
            if (s === 'admin') {
                showScreen('adminScreen');
                renderUserList();
            } else if (s === 'user') {
                showScreen('readerScreen');
                loadBook();
            } else {
                showScreen('loginScreen');
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // === –õ–û–ì–ò–ö–ê –ê–î–ú–ò–ù–ö–ò (LocalStorage) ===
        function getUsers() {
            const u = localStorage.getItem('users');
            return u ? JSON.parse(u) : [];
        }

        function addUser() {
            const l = document.getElementById('newLogin').value.trim();
            const p = document.getElementById('newPass').value.trim();
            
            if (!l || !p) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
            
            const users = getUsers();
            if (users.find(u => u.login === l)) return alert('–¢–∞–∫–æ–π –ª–æ–≥–∏–Ω —É–∂–µ –µ—Å—Ç—å');

            users.push({ login: l, pass: p });
            localStorage.setItem('users', JSON.stringify(users));
            
            document.getElementById('newLogin').value = '';
            document.getElementById('newPass').value = '';
            renderUserList();
            alert(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${l} –¥–æ–±–∞–≤–ª–µ–Ω!`);
        }

        function deleteUser(login) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${login}?`)) return;
            let users = getUsers();
            users = users.filter(u => u.login !== login);
            localStorage.setItem('users', JSON.stringify(users));
            renderUserList();
        }

        function renderUserList() {
            const list = document.getElementById('userList');
            const users = getUsers();
            
            if (users.length === 0) {
                list.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
                return;
            }

            list.innerHTML = users.map(u => `
                <div class="user-item">
                    <div>
                        <div style="font-weight:bold; color:white;">üë§ ${u.login}</div>
                        <div style="font-size:12px; color:#888;">–ü–∞—Ä–æ–ª—å: ${u.pass}</div>
                    </div>
                    <button class="del-btn" onclick="deleteUser('${u.login}')">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `).join('');
        }

        // === –ß–ò–¢–ê–õ–ö–ê (–ó–ê–ì–†–£–ó–ö–ê 50–ú–ë) ===
        async function loadBook() {
            const loader = document.getElementById('loader');
            const text = document.getElementById('loaderText');
            const bar = document.getElementById('progressBar');
            
            // –ï—Å–ª–∏ –∫–Ω–∏–≥–∞ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –≤ –ø–∞–º—è—Ç—å, –Ω–µ –∫–∞—á–∞–µ–º —Å–Ω–æ–≤–∞
            if (pdfDoc) return;

            loader.style.display = 'flex';

            try {
                // –ö–∞—á–∞–µ–º —Ñ–∞–π–ª system_core.dat —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                const response = await fetch(FILE_NAME);
                
                if (!response.ok) throw new Error('–§–∞–π–ª –∫–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω (404)');

                const contentLength = response.headers.get('content-length');
                const total = parseInt(contentLength, 10);
                let loaded = 0;

                const reader = response.body.getReader();
                const chunks = [];

                while(true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    loaded += value.length;
                    
                    if (total) {
                        const percent = Math.round((loaded / total) * 100);
                        bar.style.width = percent + '%';
                        text.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥–∏: ${percent}%`;
                    }
                }

                text.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
                
                // –°–æ–∑–¥–∞–µ–º BLOB (—Ñ–∞–π–ª –≤ –ø–∞–º—è—Ç–∏)
                const blob = new Blob(chunks, {type: 'application/pdf'});
                const url = URL.createObjectURL(blob);

                // –û—Ç–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ PDF.js
                const loadingTask = pdfjsLib.getDocument(url);
                pdfDoc = await loadingTask.promise;
                
                URL.revokeObjectURL(url); // –ß–∏—Å—Ç–∏–º –ø–∞–º—è—Ç—å –æ—Ç —Å—Å—ã–ª–∫–∏
                loader.style.display = 'none';
                renderPage(pageNum);

            } catch (error) {
                console.error(error);
                text.innerHTML = `<span style="color:#e74c3c">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏!</span><br><br><small>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª ${FILE_NAME} –Ω–∞ –º–µ—Å—Ç–µ.</small>`;
            }
        }

        // === –û–¢–†–ò–°–û–í–ö–ê –°–¢–†–ê–ù–ò–¶ ===
        function renderPage(num) {
            pdfDoc.getPage(num).then(page => {
                const canvas = document.getElementById('pdfCanvas');
                const ctx = canvas.getContext('2d');
                
                // –ü–æ–¥–≥–æ–Ω—è–µ–º –º–∞—Å—à—Ç–∞–± –ø–æ–¥ —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞
                let viewport = page.getViewport({scale: scale});
                const containerWidth = document.getElementById('viewport').clientWidth - 40;
                
                if (viewport.width > containerWidth) {
                    scale = scale * (containerWidth / viewport.width);
                    viewport = page.getViewport({scale: scale});
                }

                canvas.height = viewport.height;
                canvas.width = viewport.width;

                if (renderTask) renderTask.cancel();

                renderTask = page.render({canvasContext: ctx, viewport: viewport});
                renderTask.promise.then(() => {
                    document.getElementById('pageInfo').textContent = `${num} / ${pdfDoc.numPages}`;
                });
            });
        }

        function changePage(delta) {
            if (!pdfDoc) return;
            const newPage = pageNum + delta;
            if (newPage >= 1 && newPage <= pdfDoc.numPages) {
                pageNum = newPage;
                renderPage(pageNum);
            }
        }

        function zoom(delta) {
            scale += delta;
            if (scale < 0.2) scale = 0.2;
            renderPage(pageNum);
        }

        // === –ó–ê–©–ò–¢–ê ===
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => {
            if ((e.ctrlKey && (e.key === 's' || e.key === 'p')) || e.key === 'F12') {
                e.preventDefault();
            }
        });

    </script>
</body>
</html>