<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Corporate Library</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        /* === –°–¢–ò–õ–ò === */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; touch-action: manipulation; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #121212; color: #eee; height: 100vh; overflow: hidden; }
        
        .screen { display: none; height: 100%; width: 100%; position: absolute; top: 0; left: 0; flex-direction: column; }
        .active { display: flex; }

        /* –í–•–û–î */
        .login-container { align-items: center; justify-content: center; background: #000; }
        .login-box {
            background: #1e1e1e; padding: 30px; border-radius: 12px;
            width: 90%; max-width: 350px; text-align: center; border: 1px solid #333;
        }
        input {
            width: 100%; padding: 14px; margin: 8px 0;
            background: #333; border: 1px solid #444;
            color: white; border-radius: 8px; outline: none; font-size: 16px;
        }
        .btn {
            width: 100%; padding: 14px; margin-top: 15px;
            background: #007AFF; color: white; border: none;
            border-radius: 8px; font-weight: bold; font-size: 16px;
        }
        .error-msg { color: #ff453a; font-size: 14px; margin-top: 15px; min-height: 20px; }

        /* –ß–ò–¢–ê–õ–ö–ê */
        .reader-container { background: #000; position: relative; }
        
        /* –û–±–ª–∞—Å—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
        .viewport { 
            flex: 1; 
            overflow: auto; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; /* –í–∞–∂–Ω–æ –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ */
            padding: 10px; 
            -webkit-overflow-scrolling: touch;
        }

        /* –ö–∞–Ω–≤–∞—Å (–°—Ç—Ä–∞–Ω–∏—Ü–∞) */
        canvas { 
            display: block; 
            max-width: 100%; 
            height: auto !important; /* –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ */
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); 
        }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è) */
        .toolbar {
            background: #1c1c1e; border-top: 1px solid #333;
            padding: 10px 15px; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .ctrl-group { display: flex; gap: 15px; align-items: center; }
        .tool-btn { 
            background: #333; color: #fff; border: none; 
            width: 44px; height: 44px; border-radius: 50%; 
            font-size: 20px; display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .tool-btn:active { background: #555; }
        .page-info { font-family: monospace; color: #888; font-size: 14px; min-width: 60px; text-align: center; }

        /* –ê–¥–º–∏–Ω–∫–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è) */
        .admin-panel { background: #1a1a1a; padding: 20px; overflow-y: auto; }
        .admin-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .user-item { background: #333; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .del-btn { background: #ff453a; color: white; border: none; padding: 8px 12px; border-radius: 6px; }

        /* –ó–∞–≥—Ä—É–∑—á–∏–∫ */
        .loader-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 200;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .progress-bar-bg { width: 80%; height: 4px; background: #333; border-radius: 2px; margin-top: 20px; }
        .progress-bar-fill { width: 0%; height: 100%; background: #007AFF; transition: width 0.2s; }

        /* –ú–æ–±–∏–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è */
        @media (max-width: 768px) {
            .viewport { padding: 0; align-items: center; } /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
            .toolbar { padding-bottom: 20px; } /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ –ø–∞–ª—å—Ü—ã */
            .page-info { font-size: 12px; }
        }
    </style>
</head>
<body>

    <!-- 1. –í–•–û–î -->
    <div id="loginScreen" class="screen active login-container">
        <div class="login-box">
            <h2 style="color:#fff; margin-bottom:20px;">üìö –í—Ö–æ–¥</h2>
            <input type="text" id="loginUser" placeholder="–õ–æ–≥–∏–Ω" autocapitalize="none">
            <input type="password" id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn" onclick="handleLogin()">–í–æ–π—Ç–∏</button>
            <div class="error-msg" id="loginError"></div>
        </div>
    </div>

    <!-- 2. –ê–î–ú–ò–ù–ö–ê -->
    <div id="adminScreen" class="screen admin-panel">
        <div class="admin-header">
            <h2 style="color:#fff">‚öôÔ∏è –ê–¥–º–∏–Ω–∫–∞</h2>
            <button class="tool-btn" style="width:auto; padding:0 15px; border-radius:8px; font-size:14px;" onclick="logout()">–í—ã—Ö–æ–¥</button>
        </div>
        <div style="background:#252525; padding:15px; border-radius:10px; margin-bottom:20px;">
            <input type="text" id="newLogin" placeholder="–ù–æ–≤—ã–π –ª–æ–≥–∏–Ω">
            <input type="text" id="newPass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn" onclick="addUser()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div id="userList"></div>
    </div>

    <!-- 3. –ß–ò–¢–ê–õ–ö–ê -->
    <div id="readerScreen" class="screen reader-container">
        <!-- –û–±–ª–∞—Å—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü -->
        <div class="viewport" id="viewport">
            <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div id="loader" class="loader-overlay" style="display: none;">
                <div id="loaderText" style="color:#ccc">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥–∏...</div>
                <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressBar"></div></div>
            </div>
            
            <canvas id="pdfCanvas"></canvas>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–°–Ω–∏–∑—É) -->
        <div class="toolbar">
            <div class="ctrl-group">
                <button class="tool-btn" onclick="changePage(-1)">‚óÄ</button>
                <span class="page-info" id="pageInfo">0/0</span>
                <button class="tool-btn" onclick="changePage(1)">‚ñ∂</button>
            </div>
            
            <div class="ctrl-group">
                <button class="tool-btn" onclick="zoom(-0.2)">‚àí</button>
                <button class="tool-btn" onclick="zoom(0.2)">+</button>
                <button class="tool-btn" style="background:#ff453a" onclick="logout()">‚úï</button>
            </div>
        </div>
    </div>

    <script>
        // === –ù–ê–°–¢–†–û–ô–ö–ò ===
        const ADMIN_LOGIN = 'admin';
        const ADMIN_PASS = '123';
        const FILE_NAME = 'system_core.dat'; 

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let pdfDoc = null;
        let pageNum = 1;
        let scale = 1.0; // –ë–∞–∑–æ–≤—ã–π –º–∞—Å—à—Ç–∞–± (–±—É–¥–µ—Ç –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω)
        let renderTask = null;
        
        // –î–ª—è —Å–≤–∞–π–ø–æ–≤
        let touchStartX = 0;
        let touchEndX = 0;

        window.onload = () => {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            checkSession();
            setupSwipe(); // –í–∫–ª—é—á–∞–µ–º —Å–≤–∞–π–ø—ã
        };

        // === –õ–û–ì–ò–ö–ê –í–•–û–î–ê ===
        function handleLogin() {
            const l = document.getElementById('loginUser').value.trim();
            const p = document.getElementById('loginPass').value.trim();
            const err = document.getElementById('loginError');

            if (l === ADMIN_LOGIN && p === ADMIN_PASS) {
                localStorage.setItem('session', 'admin');
                showScreen('adminScreen');
                renderUserList();
                return;
            }

            const users = getUsers();
            if (users.find(u => u.login === l && u.pass === p)) {
                localStorage.setItem('session', 'user');
                showScreen('readerScreen');
                loadBook();
            } else {
                err.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
            }
        }

        function logout() { localStorage.removeItem('session'); location.reload(); }

        function checkSession() {
            const s = localStorage.getItem('session');
            if (s === 'admin') { showScreen('adminScreen'); renderUserList(); }
            else if (s === 'user') { showScreen('readerScreen'); loadBook(); }
            else { showScreen('loginScreen'); }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // === –ê–î–ú–ò–ù–ö–ê ===
        function getUsers() { return JSON.parse(localStorage.getItem('users') || '[]'); }
        
        function addUser() {
            const l = document.getElementById('newLogin').value.trim();
            const p = document.getElementById('newPass').value.trim();
            if (!l || !p) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
            const users = getUsers();
            if (users.find(u => u.login === l)) return alert('–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç');
            users.push({ login: l, pass: p });
            localStorage.setItem('users', JSON.stringify(users));
            renderUserList();
            document.getElementById('newLogin').value = '';
            document.getElementById('newPass').value = '';
        }

        function deleteUser(login) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
            const users = getUsers().filter(u => u.login !== login);
            localStorage.setItem('users', JSON.stringify(users));
            renderUserList();
        }

        function renderUserList() {
            const list = document.getElementById('userList');
            const users = getUsers();
            list.innerHTML = users.map(u => `
                <div class="user-item">
                    <div style="color:white; font-weight:bold">${u.login} <span style="font-weight:normal; color:#888; font-size:12px">(${u.pass})</span></div>
                    <button class="del-btn" onclick="deleteUser('${u.login}')">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `).join('');
        }

        // === –ó–ê–ì–†–£–ó–ö–ê –ö–ù–ò–ì–ò ===
        async function loadBook() {
            if (pdfDoc) return;
            const loader = document.getElementById('loader');
            const bar = document.getElementById('progressBar');
            const text = document.getElementById('loaderText');
            loader.style.display = 'flex';

            try {
                const response = await fetch(FILE_NAME);
                if (!response.ok) throw new Error('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
                
                const total = parseInt(response.headers.get('content-length'), 10);
                let loaded = 0;
                const reader = response.body.getReader();
                const chunks = [];

                while(true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    loaded += value.length;
                    if(total) {
                        const pct = Math.round((loaded/total)*100);
                        bar.style.width = pct + '%';
                        text.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞: ${pct}%`;
                    }
                }

                const blob = new Blob(chunks, {type: 'application/pdf'});
                const url = URL.createObjectURL(blob);
                
                text.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
                const task = pdfjsLib.getDocument(url);
                pdfDoc = await task.promise;
                URL.revokeObjectURL(url);
                
                loader.style.display = 'none';
                
                // –ê–≤—Ç–æ-–ø–æ–¥–≥–æ–Ω –º–∞—Å—à—Ç–∞–±–∞ –ø–æ–¥ —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
                fitToScreen();
                
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message);
            }
        }

        // === –û–¢–†–ò–°–û–í–ö–ê (HD –ö–ê–ß–ï–°–¢–í–û) ===
        function fitToScreen() {
            if (!pdfDoc) return;
            pdfDoc.getPage(1).then(page => {
                const viewport = page.getViewport({scale: 1.0});
                const containerWidth = document.getElementById('viewport').clientWidth;
                // –°—á–∏—Ç–∞–µ–º –º–∞—Å—à—Ç–∞–±, —á—Ç–æ–±—ã —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–Ω–∏–º–∞–ª–∞ 95% —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞
                scale = (containerWidth / viewport.width) * 0.95;
                renderPage(pageNum);
            });
        }

        function renderPage(num) {
            if (renderTask) renderTask.cancel();
            
            pdfDoc.getPage(num).then(page => {
                const canvas = document.getElementById('pdfCanvas');
                const ctx = canvas.getContext('2d');
                
                // –í–ê–ñ–ù–û: –£–º–Ω–æ–∂–∞–µ–º –Ω–∞ devicePixelRatio –¥–ª—è —á–µ—Ç–∫–æ—Å—Ç–∏ –Ω–∞ iPhone/Android
                const pixelRatio = window.devicePixelRatio || 1;
                const viewport = page.getViewport({ scale: scale * pixelRatio });

                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                // CSS –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –∫–∞–Ω–≤–∞—Å –≤–ø–∏—Å–∞—Ç—å—Å—è –≤ —ç–∫—Ä–∞–Ω, –Ω–æ –ø–∏–∫—Å–µ–ª–µ–π –≤–Ω—É—Ç—Ä–∏ –º–Ω–æ–≥–æ -> —á–µ—Ç–∫–æ
                canvas.style.width = `${viewport.width / pixelRatio}px`;
                canvas.style.height = `${viewport.height / pixelRatio}px`;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport,
                    transform: [pixelRatio, 0, 0, pixelRatio, 0, 0] // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è HiDPI
                };

                renderTask = page.render(renderContext);
                renderTask.promise.then(() => {
                    document.getElementById('pageInfo').textContent = `${num}/${pdfDoc.numPages}`;
                });
            });
        }

        function changePage(d) {
            if (!pdfDoc) return;
            const newPage = pageNum + d;
            if (newPage >= 1 && newPage <= pdfDoc.numPages) {
                pageNum = newPage;
                renderPage(pageNum);
                // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                document.getElementById('viewport').scrollTop = 0;
            }
        }

        function zoom(d) {
            scale += d;
            if (scale < 0.2) scale = 0.2;
            renderPage(pageNum);
        }

        // === –°–í–ê–ô–ü–´ (–õ–ò–°–¢–ê–ù–ò–ï –ü–ê–õ–¨–¶–ï–ú) ===
        function setupSwipe() {
            const view = document.getElementById('viewport');
            
            view.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            });

            view.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });
        }

        function handleSwipe() {
            const limit = 50; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–≤–∞–π–ø–∞
            if (touchEndX < touchStartX - limit) {
                changePage(1); // –°–≤–∞–π–ø –≤–ª–µ–≤–æ -> —Å–ª–µ–¥—É—é—â–∞—è
            }
            if (touchEndX > touchStartX + limit) {
                changePage(-1); // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ -> –ø—Ä–µ–¥—ã–¥—É—â–∞—è
            }
        }

        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        document.addEventListener('contextmenu', e => e.preventDefault());
    </script>
</body>
</html>