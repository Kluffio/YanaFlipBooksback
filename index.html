<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ß–∏—Ç–∞–ª–∫–∞</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
/* ===== –û–ë–©–ï–ï ===== */
body {
  margin:0;
  background:#111;
  color:#fff;
  font-family:system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

.hidden { display:none; }

/* ===== LOGIN ===== */
#loginBox {
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}

.loginCard {
  background:#1b1b1b;
  padding:28px;
  border-radius:14px;
  width:100%;
  max-width:360px;
  box-shadow:0 10px 30px rgba(0,0,0,.5);
}

.loginCard h2 {
  margin-top:0;
  text-align:center;
}

.loginCard input {
  width:100%;
  padding:14px;
  margin:10px 0;
  font-size:16px;
  border-radius:10px;
  border:none;
}

.loginCard button {
  width:100%;
  padding:14px;
  margin-top:10px;
  font-size:16px;
  border-radius:10px;
  border:none;
  background:#3a82f7;
  color:#fff;
}

/* ===== READER ===== */
#pdf {
  display:flex;
  flex-direction:column;
  align-items:center;
}

canvas {
  background:#fff;
  display:block;
}

/* ===== –†–ê–ó–í–û–†–û–¢ ===== */
.spread {
  display:flex;
  gap:2px;
  margin-bottom:32px;
}

.mobile .spread {
  flex-direction:column;
  gap:0;
}

/* ===== ZOOM ===== */
.zoomControls {
  position:fixed;
  right:16px;
  bottom:16px;
  z-index:999;
}
.zoomControls button {
  font-size:22px;
  padding:12px 16px;
  margin:4px;
}

/* ===== –ê–î–ú–ò–ù–ö–ê ===== */
#adminBox {
  padding:20px;
}

.adminUser {
  border:1px solid #333;
  border-radius:10px;
  padding:12px;
  margin-bottom:10px;
}

.adminUser b {
  font-size:15px;
}

.adminUser button {
  margin-top:6px;
  padding:6px 10px;
  border-radius:6px;
  border:none;
}

.blocked {
  opacity:0.5;
}

.warn {
  color:#ff5555;
}
</style>
</head>

<body>

<h2 id="title" style="text-align:center;padding:10px">–ß–∏—Ç–∞–ª–∫–∞</h2>

<!-- LOGIN -->
<div id="loginBox">
  <div class="loginCard">
    <h2>–í—Ö–æ–¥</h2>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button onclick="login()">–í–æ–π—Ç–∏</button>
  </div>
</div>

<!-- ADMIN -->
<div id="adminBox" class="hidden">
  <h3>–ê–¥–º–∏–Ω–∫–∞</h3>
  <div id="userList"></div>
</div>

<!-- READER -->
<div id="readerBox" class="hidden">
  <div id="pdf"></div>
</div>

<!-- ZOOM -->
<div class="zoomControls hidden" id="zoomControls">
  <button onclick="changeZoom(0.2)">+</button>
  <button onclick="changeZoom(-0.2)">‚àí</button>
</div>

<script>
/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey: "AIzaSyBI_MW2hD1k5ORHZF_56zVzJvelHSVnvko",
  authDomain: "book-aed2c.firebaseapp.com",
  projectId: "book-aed2c"
});
const auth = firebase.auth();
const db = firebase.firestore();

/* ===== STATE ===== */
const isMobile = window.innerWidth < 700;
if (isMobile) document.body.classList.add("mobile");

let SCALE = isMobile ? 1.2 : 1.8;
let pdfDoc = null;
let zoomTimer = null;

/* ===== LOGIN ===== */
function login() {
  auth.signInWithEmailAndPassword(email.value, password.value)
    .then(afterLogin)
    .catch(() => alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å"));
}

async function afterLogin() {
  const user = auth.currentUser;
  const ref = db.collection("users").doc(user.email);
  const snap = await ref.get();

  if (!snap.exists) {
    await ref.set({ role:"user", logins:0, devices:{} });
  }

  const deviceId = navigator.userAgent + screen.width + screen.height;
  await ref.set({
    logins: firebase.firestore.FieldValue.increment(1),
    devices: { [btoa(deviceId)]: true }
  }, { merge:true });

  const data = (await ref.get()).data();
  if (data.blocked) {
    alert("–î–æ—Å—Ç—É–ø –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω");
    auth.signOut();
    return;
  }

  loginBox.classList.add("hidden");
  readerBox.classList.remove("hidden");
  zoomControls.classList.remove("hidden");

  if (data.role === "admin") {
    adminBox.classList.remove("hidden");
    loadUsers();
  }

  loadPDF();
}

/* ===== PDF ===== */
function loadPDF() {
  pdfjsLib.getDocument("book.pdf").promise.then(pdf => {
    pdfDoc = pdf;
    renderAll();
  });
}

function renderAll() {
  const box = document.getElementById("pdf");
  box.innerHTML = "";

  for (let i = 1; i <= pdfDoc.numPages; i++) {
    renderPage(i);
  }
}

function renderPage(num) {
  pdfDoc.getPage(num).then(page => {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    const dpr = window.devicePixelRatio || 1;
    const viewport = page.getViewport({ scale: SCALE });

    canvas.width = viewport.width * dpr;
    canvas.height = viewport.height * dpr;
    canvas.style.width = viewport.width + "px";
    canvas.style.height = viewport.height + "px";

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    page.render({ canvasContext: ctx, viewport });

    if (isMobile || num === 1) {
      document.getElementById("pdf").appendChild(canvas);
    } else {
      let last = document.querySelector(".spread:last-child");
      if (!last || last.children.length === 2) {
        last = document.createElement("div");
        last.className = "spread";
        document.getElementById("pdf").appendChild(last);
      }
      last.appendChild(canvas);
    }
  });
}

/* ===== ZOOM ===== */
function changeZoom(delta) {
  SCALE = Math.max(0.8, SCALE + delta);
  clearTimeout(zoomTimer);
  zoomTimer = setTimeout(renderAll, 250);
}

/* ===== ADMIN ===== */
async function loadUsers() {
  const snap = await db.collection("users").get();
  const box = document.getElementById("userList");
  box.innerHTML = "";

  snap.forEach(doc => {
    const d = doc.data();
    const devices = d.devices ? Object.keys(d.devices).length : 0;
    const blocked = d.blocked;

    box.innerHTML += `
      <div class="adminUser ${blocked ? "blocked" : ""}">
        <b>${doc.id}</b><br>
        –í—Ö–æ–¥–æ–≤: ${d.logins || 0}<br>
        –£—Å—Ç—Ä–æ–π—Å—Ç–≤: ${devices} ${devices > 2 ? "üö®" : ""}<br>
        <button onclick="toggleBlock('${doc.id}', ${!!blocked})">
          ${blocked ? "–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" : "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å"}
        </button>
      </div>
    `;
  });
}

function toggleBlock(email, isBlocked) {
  db.collection("users").doc(email).update({ blocked: !isBlocked });
  loadUsers();
}
</script>

</body>
</html>
