<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ß–∏—Ç–∞–ª–∫–∞</title>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
html, body {
    margin: 0;
    padding: 0;
    background: #111;
    color: white;
    height: 100%;
    overflow: hidden;
    user-select: none;
}

#status {
    text-align: center;
    margin-top: 40vh;
    font-size: 18px;
    opacity: 0.8;
}

#viewer {
    display: none;
    height: 100vh;
    overflow-y: auto;
}

.row {
    display: flex;
    justify-content: center;
}

canvas {
    margin: 10px;
    max-width: 100%;
}
</style>
</head>

<body>

<div id="status">–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø‚Ä¶</div>
<div id="viewer"></div>

<script>
/* ===== –ù–ê–°–¢–†–û–ô–ö–ò ===== */

// üëâ –í–°–¢–ê–í–¨ –°–Æ–î–ê URL –°–í–û–ï–ì–û –°–ï–†–í–ï–†–ê RENDER
const CHECK_URL = "https://tg-channel-check.onrender.com";

/* ===== TELEGRAM ===== */
const tg = window.Telegram.WebApp;
tg.expand();

const userId = tg.initDataUnsafe?.user?.id;

if (!userId) {
    document.getElementById("status").innerText =
        "–û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ —á–µ—Ä–µ–∑ Telegram";
    throw new Error("Not Telegram");
}

/* ===== –ü–†–û–í–ï–†–ö–ê –ü–û–î–ü–ò–°–ö–ò ===== */
fetch(`${CHECK_URL}/check?user=${userId}`)
    .then(r => r.json())
    .then(data => {
        if (!data.ok) {
            document.getElementById("status").innerText =
                "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞. –ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª.";
        } else {
            document.getElementById("status").style.display = "none";
            document.getElementById("viewer").style.display = "block";
            startReader();
        }
    })
    .catch(() => {
        document.getElementById("status").innerText =
            "–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞";
    });

/* ===== PDF –ß–ò–¢–ê–õ–ö–ê ===== */
function startReader() {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    const PDF_FILE = "book.pdf";
    const viewer = document.getElementById("viewer");
    let pdfDoc = null;

    function isLandscape() {
        return window.innerWidth > window.innerHeight;
    }

    function render() {
        viewer.innerHTML = "";
        let page = 1;
        const perRow = isLandscape() ? 2 : 1;

        function drawRow() {
            if (page > pdfDoc.numPages) return;

            const row = document.createElement("div");
            row.className = "row";

            for (let i = 0; i < perRow && page <= pdfDoc.numPages; i++) {
                const current = page++;

                pdfDoc.getPage(current).then(p => {
                    const vp = p.getViewport({ scale: 1.4 });
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");

                    canvas.width = vp.width;
                    canvas.height = vp.height;
                    row.appendChild(canvas);

                    p.render({
                        canvasContext: ctx,
                        viewport: vp
                    });
                });
            }

            viewer.appendChild(row);
            setTimeout(drawRow, 30);
        }

        drawRow();
    }

    pdfjsLib.getDocument(PDF_FILE).promise.then(pdf => {
        pdfDoc = pdf;
        render();
    });

    window.addEventListener("resize", render);
}
</script>

</body>
</html>
