<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–Ω–∏–≥–∞</title>
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ PDF -->
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js"></script>
    <style>
        /* === –ë–ê–ó–ê === */
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: pan-y; }
        body { background: #1e1e1e; height: 100vh; overflow: hidden; font-family: sans-serif; }
        
        .screen { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; flex-direction: column; }
        .active { display: flex; }

        /* === –í–•–û–î === */
        .login-box {
            margin: auto; background: #2d2d2d; padding: 30px; border-radius: 15px;
            text-align: center; color: white; width: 90%; max-width: 350px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 8px; border: none; font-size: 16px; }
        .btn { width: 100%; padding: 15px; background: #007AFF; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn:disabled { background: #555; }

        /* === –ß–ò–¢–ê–õ–ö–ê === */
        .reader-ui { 
            flex: 1; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; 
            background: #111;
        }
        
        /* –†–∞–∑–≤–æ—Ä–æ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü */
        .book-spread {
            display: flex; align-items: center; justify-content: center;
            gap: 0; /* –°—Ç—Ä–∞–Ω–∏—Ü—ã –≤–ø–ª–æ—Ç–Ω—É—é */
            box-shadow: 0 5px 30px rgba(0,0,0,0.5);
            transition: opacity 0.2s;
        }

        canvas { display: block; background: white; }

        /* === –ö–ù–û–ü–ö–ò –ù–ê–í–ò–ì–ê–¶–ò–ò (–°–¢–†–ï–õ–ö–ò –ü–û –ë–û–ö–ê–ú) === */
        .nav-arrow {
            position: absolute; top: 0; bottom: 0; width: 15%; /* –®–∏—Ä–æ–∫–∞—è –∑–æ–Ω–∞ –Ω–∞–∂–∞—Ç–∏—è */
            background: transparent; border: none; cursor: pointer; z-index: 50;
            display: flex; align-items: center; justify-content: center;
            color: rgba(255,255,255,0.3); font-size: 40px; user-select: none;
            transition: color 0.2s, background 0.2s;
        }
        .nav-prev { left: 0; }
        .nav-next { right: 0; }
        
        /* –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –∏–ª–∏ –Ω–∞–∂–∞—Ç–∏–∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º */
        .nav-arrow:active, .nav-arrow:hover {
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.8);
        }

        /* === –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ === */
        .controls {
            height: 60px; background: #1c1c1e; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; z-index: 100; border-top: 1px solid #333;
        }
        .btn-icon {
            background: #333; color: white; border: none; width: 40px; height: 40px; border-radius: 8px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .page-counter { color: #aaa; font-family: monospace; font-size: 14px; }
        
        /* === –ó–ê–ì–†–£–ó–ö–ê === */
        .loader { position: absolute; top:0; left:0; width:100%; height:100%; background:#1e1e1e; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; }
        .progress { width: 200px; height: 4px; background: #333; margin-top: 15px; border-radius: 2px; }
        .bar { width: 0%; height: 100%; background: #007AFF; transition: width 0.2s; }
    </style>
</head>
<body>

    <!-- –≠–ö–†–ê–ù –í–•–û–î–ê -->
    <div id="loginScreen" class="screen active">
        <div class="login-box">
            <h2>üîê –í—Ö–æ–¥</h2>
            <br>
            <input type="text" id="l_login" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="l_pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button id="loginBtn" class="btn" onclick="login()">–û—Ç–∫—Ä—ã—Ç—å –∫–Ω–∏–≥—É</button>
            <div id="error" style="color:#ff453a; margin-top:10px; font-size:14px;"></div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù –ö–ù–ò–ì–ò -->
    <div id="bookScreen" class="screen">
        <div class="reader-ui" id="viewport">
            <!-- –°—Ç—Ä–µ–ª–∫–∏ –ø–æ –±–æ–∫–∞–º (—Ä–∞–±–æ—Ç–∞—é—Ç –∏ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ) -->
            <button class="nav-arrow nav-prev" onclick="changePage(-1)">‚ùÆ</button>
            <button class="nav-arrow nav-next" onclick="changePage(1)">‚ùØ</button>
            
            <!-- –ú–µ—Å—Ç–æ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü -->
            <div id="spread" class="book-spread"></div>
            
            <!-- –ó–∞–≥—Ä—É–∑—á–∏–∫ -->
            <div id="loader" class="loader" style="display:none">
                <div id="loaderText">–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏...</div>
                <div class="progress"><div class="bar" id="pBar"></div></div>
            </div>
        </div>

        <div class="controls">
            <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∞: 1 —Å—Ç—Ä / 2 —Å—Ç—Ä -->
            <button class="btn-icon" onclick="toggleMode()" id="modeBtn">üìñ</button>
            
            <span class="page-counter" id="pageInfo">0/0</span>
            
            <button class="btn-icon" style="font-size: 14px" onclick="logout()">–í—ã—Ö–æ–¥</button>
        </div>
    </div>

    <script>
        // === –ù–ê–°–¢–†–û–ô–ö–ò ===
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby7WCduakFRoipv2nOY2f93txxy5oKuQoKZzsZLNvtaBhJpqmXAbNekcCtCLKw6Guh18Q/exec';
        const FILE = 'system_core.dat'; // –ò–º—è —Ñ–∞–π–ª–∞ 57 –ú–ë
        
        let pdfDoc = null;
        let pageNum = 1;
        let isDualPage = true; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—Ç–∞—Ä–∞–µ–º—Å—è –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–∞–∑–≤–æ—Ä–æ—Ç
        let isRendering = false;

        window.onload = () => {
            if(localStorage.getItem('auth')) showBook();
            window.addEventListener('resize', () => { if(pdfDoc) render(); });
        };

        // === –í–•–û–î ===
        async function login() {
            const l = document.getElementById('l_login').value.trim();
            const p = document.getElementById('l_pass').value.trim();
            const btn = document.getElementById('loginBtn');
            const err = document.getElementById('error');

            if(!l || !p) return;
            btn.disabled = true; btn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...'; err.textContent = '';

            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?login=${encodeURIComponent(l)}&pass=${encodeURIComponent(p)}`);
                const result = await response.text();
                if(result.includes("SUCCESS")) {
                    localStorage.setItem('auth', 'true');
                    showBook();
                } else {
                    err.textContent = '–ù–µ–≤–µ—Ä–Ω–æ'; btn.disabled = false; btn.textContent = '–û—Ç–∫—Ä—ã—Ç—å –∫–Ω–∏–≥—É';
                }
            } catch(e) {
                err.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'; btn.disabled = false; btn.textContent = '–û—Ç–∫—Ä—ã—Ç—å –∫–Ω–∏–≥—É';
            }
        }

        function showBook() {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('bookScreen').classList.add('active');
            loadPDF();
        }

        function logout() { localStorage.removeItem('auth'); location.reload(); }

        // === –ó–ê–ì–†–£–ó–ö–ê ===
        async function loadPDF() {
            if(pdfDoc) return;
            const loader = document.getElementById('loader');
            const bar = document.getElementById('pBar');
            loader.style.display = 'flex';

            try {
                const response = await fetch(FILE);
                if (!response.ok) throw new Error('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
                const total = parseInt(response.headers.get('content-length'), 10);
                let loaded = 0;
                const reader = response.body.getReader();
                const chunks = [];
                while(true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    loaded += value.length;
                    if(total) bar.style.width = Math.round((loaded/total)*100) + '%';
                }
                const blob = new Blob(chunks, {type: 'application/pdf'});
                const url = URL.createObjectURL(blob);
                
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
                const task = pdfjsLib.getDocument(url);
                pdfDoc = await task.promise;
                loader.style.display = 'none';
                
                // –ê–≤—Ç–æ-–≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞: –µ—Å–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ - 1 —Å—Ç—Ä, –∏–Ω–∞—á–µ 2
                if(window.innerWidth < window.innerHeight) isDualPage = false;
                
                render();
            } catch(e) { alert('–û—à–∏–±–∫–∞: ' + e.message); }
        }

        // === –†–ï–ù–î–ï–†–ò–ù–ì (–†–ê–ó–í–û–†–û–¢–´) ===
        async function render() {
            if(!pdfDoc || isRendering) return;
            isRendering = true;

            const spreadEl = document.getElementById('spread');
            spreadEl.innerHTML = '';
            spreadEl.style.opacity = '0'; // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ

            // –ö–Ω–æ–ø–∫–∞ —Ä–µ–∂–∏–º–∞
            document.getElementById('modeBtn').textContent = isDualPage ? 'üìÑ' : 'üìñ';

            // –ï—Å–ª–∏ —Ä–∞–∑–≤–æ—Ä–æ—Ç –≤–∫–ª—é—á–µ–Ω, –Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–≤–∞—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–¥–Ω—É (–æ–±–ª–æ–∂–∫—É)
            const showTwo = isDualPage && pageNum > 1 && pageNum < pdfDoc.numPages;

            await renderCanvas(pageNum, spreadEl, showTwo);
            
            if (showTwo) {
                await renderCanvas(pageNum + 1, spreadEl, showTwo);
                document.getElementById('pageInfo').textContent = `${pageNum}-${pageNum+1} / ${pdfDoc.numPages}`;
            } else {
                document.getElementById('pageInfo').textContent = `${pageNum} / ${pdfDoc.numPages}`;
            }

            spreadEl.style.opacity = '1';
            isRendering = false;
        }

        async function renderCanvas(num, parent, isTwo) {
            const page = await pdfDoc.getPage(num);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const viewportRaw = page.getViewport({scale: 1});
            
            // –†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–æ–≤
            const container = document.getElementById('viewport');
            let availW = container.clientWidth;
            const availH = container.clientHeight;

            if(isTwo) availW = availW / 2;

            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–ª–µ–∑–ª–∞ —Ü–µ–ª–∏–∫–æ–º (contain)
            const scaleW = availW / viewportRaw.width;
            const scaleH = availH / viewportRaw.height;
            const scale = Math.min(scaleW, scaleH) * 0.95; // 0.95 –¥–ª—è –Ω–µ–±–æ–ª—å—à–æ–≥–æ –æ—Ç—Å—Ç—É–ø–∞

            // –í—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ (Retina)
            const pixelRatio = window.devicePixelRatio || 1;
            const viewport = page.getViewport({scale: scale * pixelRatio});

            canvas.width = viewport.width;
            canvas.height = viewport.height;
            canvas.style.width = `${viewport.width / pixelRatio}px`;
            canvas.style.height = `${viewport.height / pixelRatio}px`;

            parent.appendChild(canvas);
            await page.render({
                canvasContext: ctx, 
                viewport: viewport,
                transform: [pixelRatio, 0, 0, pixelRatio, 0, 0]
            }).promise;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ (1 —Å—Ç—Ä –∏–ª–∏ 2 —Å—Ç—Ä)
        function toggleMode() {
            isDualPage = !isDualPage;
            // –ï—Å–ª–∏ –≤–∫–ª—é—á–∏–ª–∏ —Ä–∞–∑–≤–æ—Ä–æ—Ç, —É–±–µ–¥–∏–º—Å—è —á—Ç–æ –ª–µ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —á–µ—Ç–Ω–∞—è –∏–ª–∏ –ø–µ—Ä–≤–∞—è
            if(isDualPage && pageNum % 2 !== 0 && pageNum !== 1) pageNum--;
            render();
        }

        function changePage(delta) {
            if(!pdfDoc) return;
            const step = (isDualPage && pageNum > 1) ? 2 : 1;
            const newPage = pageNum + (delta * step);
            
            if(newPage >= 1 && newPage <= pdfDoc.numPages) {
                pageNum = newPage;
                render();
            }
        }
    </script>
</body>
</html>