<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Читалка</title>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
html, body {
    margin: 0;
    padding: 0;
    background: #111;
    color: white;
    height: 100%;
    overflow: hidden;
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
}

#viewer {
    height: 100vh;
    overflow-y: auto;
}

.page-row {
    display: flex;
    justify-content: center;
}

canvas {
    margin: 10px;
    max-width: 100%;
}
</style>
</head>

<body>
<div id="viewer"></div>

<script>
/* ===== Telegram check ===== */
const tg = window.Telegram.WebApp;
tg.expand();

if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
    document.body.innerHTML =
        "<h2 style='text-align:center;margin-top:40vh;'>Открывайте через Telegram</h2>";
    throw new Error("Not Telegram");
}

/* ===== PDF.js setup ===== */
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

const PDF_URL = "book.pdf"; // имя PDF
const viewer = document.getElementById("viewer");

let pdfDoc = null;
const SCALE = 1.4;

/* ===== helpers ===== */
function isLandscape() {
    return window.innerWidth > window.innerHeight;
}

/* ===== render ===== */
function renderPDF() {
    viewer.innerHTML = "";

    const pagesPerRow = isLandscape() ? 2 : 1;
    let pageNum = 1;

    function renderRow() {
        if (pageNum > pdfDoc.numPages) return;

        const row = document.createElement("div");
        row.className = "page-row";

        for (let i = 0; i < pagesPerRow && pageNum <= pdfDoc.numPages; i++) {
            const currentPage = pageNum;

            pdfDoc.getPage(currentPage).then(page => {
                const viewport = page.getViewport({ scale: SCALE });
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");

                canvas.width = viewport.width;
                canvas.height = viewport.height;

                row.appendChild(canvas);

                page.render({
                    canvasContext: ctx,
                    viewport: viewport
                });
            });

            pageNum++;
        }

        viewer.appendChild(row);
        setTimeout(renderRow, 30);
    }

    renderRow();
}

/* ===== load PDF ===== */
pdfjsLib.getDocument(PDF_URL).promise.then(pdf => {
    pdfDoc = pdf;
    renderPDF();
});

/* ===== re-render on rotate ===== */
window.addEventListener("resize", () => {
    renderPDF();
});
</script>
</body>
</html>
