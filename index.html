<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ß–∏—Ç–∞–ª–∫–∞</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
* { box-sizing:border-box; }

body {
  margin:0;
  background:#111;
  color:#fff;
  font-family:system-ui, sans-serif;
  overflow:hidden;
}

/* ===== –≠–ö–†–ê–ù–´ ===== */
.screen {
  position:fixed;
  inset:0;
  display:none;
  background:#111;
}

.screen.active {
  display:flex;
  flex-direction:column;
}

/* ===== LOGIN ===== */
#screen-login {
  justify-content:center;
  align-items:center;
}

.loginCard {
  background:#1b1b1b;
  padding:28px;
  border-radius:14px;
  width:100%;
  max-width:360px;
}

.loginCard input,
.loginCard button {
  width:100%;
  padding:14px;
  margin:10px 0;
  font-size:16px;
  border-radius:10px;
  border:none;
}

.loginCard button {
  background:#3a82f7;
  color:#fff;
}

/* ===== HEADER ===== */
header {
  height:56px;
  flex-shrink:0;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 12px;
  background:#000;
}

header button {
  margin-left:6px;
  padding:6px 10px;
}

/* ===== CONTENT ===== */
.content {
  flex:1;
  overflow-y:auto;
  padding:20px;
}

/* ===== PDF ===== */
#pdf {
  display:flex;
  flex-direction:column;
  align-items:center;
}

canvas {
  background:#fff;
  display:block;
  margin-bottom:30px;
}

/* ===== ZOOM ===== */
.zoomControls {
  position:fixed;
  right:16px;
  bottom:16px;
  z-index:9999;
}

.zoomControls button {
  width:44px;
  height:44px;
  font-size:22px;
  margin-top:6px;
  border:none;
  border-radius:10px;
  background:#fff;
  color:#000;
}
</style>
</head>

<body>

<!-- LOGIN -->
<section id="screen-login" class="screen active">
  <div class="loginCard">
    <h2 style="text-align:center">–í—Ö–æ–¥</h2>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button onclick="login()">–í–æ–π—Ç–∏</button>
  </div>
</section>

<!-- READER -->
<section id="screen-reader" class="screen">
  <header>
    <div>üìñ –ß–∏—Ç–∞–ª–∫–∞</div>
    <div>
      <button onclick="showScreen('reader')">–ö–Ω–∏–≥–∞</button>
      <button onclick="showScreen('admin')" id="adminBtn" style="display:none">–ê–¥–º–∏–Ω–∫–∞</button>
      <button onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>
  </header>
  <div class="content">
    <div id="pdf"></div>
  </div>
</section>

<!-- ADMIN -->
<section id="screen-admin" class="screen">
  <header>
    <div>‚öô –ê–¥–º–∏–Ω–∫–∞</div>
    <div>
      <button onclick="showScreen('reader')">–ù–∞–∑–∞–¥</button>
      <button onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>
  </header>
  <div class="content" id="userList"></div>
</section>

<!-- ZOOM -->
<div class="zoomControls" id="zoomControls" style="display:none">
  <button onclick="zoomIn()">+</button>
  <button onclick="zoomOut()">‚àí</button>
</div>

<script>
/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey: "AIzaSyBI_MW2hD1k5ORHZF_56zVzJvelHSVnvko",
  authDomain: "book-aed2c.firebaseapp.com",
  projectId: "book-aed2c"
});
const auth = firebase.auth();
const db = firebase.firestore();

/* ===== STATE ===== */
let SCALE = 1.6;
let pdfDoc = null;
let zoomTimer = null;

/* ===== SCREEN ===== */
function showScreen(name) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById("screen-" + name).classList.add("active");

  document.getElementById("zoomControls").style.display =
    name === "reader" ? "block" : "none";
}

/* ===== LOGIN ===== */
function login() {
  auth.signInWithEmailAndPassword(email.value, password.value)
    .then(afterLogin)
    .catch(() => alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞"));
}

async function afterLogin() {
  const user = auth.currentUser;
  const ref = db.collection("users").doc(user.email);
  const snap = await ref.get();

  if (!snap.exists) {
    await ref.set({ role:"user", logins:0 });
  }

  await ref.update({ logins: firebase.firestore.FieldValue.increment(1) });
  const data = (await ref.get()).data();

  showScreen("reader");
  loadPDF();

  if (data.role === "admin") {
    document.getElementById("adminBtn").style.display = "inline-block";
    loadUsers();
  }
}

/* ===== LOGOUT ===== */
function logout() {
  auth.signOut();
  location.reload();
}

/* ===== PDF ===== */
function loadPDF() {
  pdfjsLib.getDocument("book.pdf").promise.then(pdf => {
    pdfDoc = pdf;
    renderAll();
  });
}

function renderAll() {
  pdf.innerHTML = "";
  for (let i = 1; i <= pdfDoc.numPages; i++) {
    pdfDoc.getPage(i).then(page => {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      const dpr = window.devicePixelRatio || 1;
      const viewport = page.getViewport({ scale: SCALE });

      canvas.width = viewport.width * dpr;
      canvas.height = viewport.height * dpr;
      canvas.style.width = viewport.width + "px";
      canvas.style.height = viewport.height + "px";

      ctx.setTransform(dpr,0,0,dpr,0,0);
      page.render({ canvasContext: ctx, viewport });
      pdf.appendChild(canvas);
    });
  }
}

/* ===== ZOOM ===== */
function zoomIn() {
  SCALE += 0.2;
  debounceRender();
}

function zoomOut() {
  SCALE = Math.max(0.6, SCALE - 0.2);
  debounceRender();
}

function debounceRender() {
  clearTimeout(zoomTimer);
  zoomTimer = setTimeout(renderAll, 200);
}

/* ===== ADMIN ===== */
async function loadUsers() {
  const snap = await db.collection("users").get();
  userList.innerHTML = "";

  snap.forEach(doc => {
    const d = doc.data();
    userList.innerHTML += `
      <div style="border:1px solid #333;padding:12px;border-radius:8px;margin-bottom:10px">
        <b>${doc.id}</b><br>
        –í—Ö–æ–¥–æ–≤: ${d.logins || 0}
      </div>
    `;
  });
}
</script>

</body>
</html>
