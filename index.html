<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ß–∏—Ç–∞–ª–∫–∞</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#111;
  color:#fff;
  font-family:system-ui,sans-serif;
  overflow:hidden;
}

/* screens */
.screen{
  position:fixed;
  inset:0;
  display:none;
  flex-direction:column;
}
.screen.active{display:flex}

/* header */
header{
  height:56px;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 12px;
}
header button{
  margin-left:6px;
  padding:8px 12px;
  border-radius:8px;
  border:none;
}

/* content */
.content{
  flex:1;
  overflow-y:auto;
  padding:20px 0;
}

/* login */
#loginScreen{
  justify-content:center;
  align-items:center;
}
.loginBox{
  background:#1c1c1c;
  padding:28px;
  border-radius:16px;
  width:100%;
  max-width:360px;
}
.loginBox input,
.loginBox button{
  width:100%;
  padding:14px;
  margin-top:12px;
  font-size:16px;
  border-radius:10px;
  border:none;
}
.loginBox input:focus-visible{
  outline:2px solid #3a82f7;
}
.loginBox button{
  background:#3a82f7;
  color:#fff;
}
.loginBox button:active{transform:scale(.97)}

/* pdf */
#pdf{
  display:flex;
  flex-direction:column;
  align-items:center;
}
.cover{
  margin-bottom:40px;
}
.spread{
  display:flex;
  gap:6px;
  margin-bottom:36px;
}
canvas{
  background:#fff;
  display:block;
}

/* zoom */
.zoom{
  position:fixed;
  right:16px;
  bottom:16px;
  z-index:9999;
}
.zoom button{
  width:44px;
  height:44px;
  font-size:22px;
  border:none;
  border-radius:10px;
  margin-top:6px;
}

/* mobile */
@media(max-width:700px){
  .spread{flex-direction:column;gap:0}
}
</style>
</head>

<body>

<!-- LOGIN -->
<section id="loginScreen" class="screen active">
  <div class="loginBox">
    <h2 style="text-align:center">–í—Ö–æ–¥</h2>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button onclick="login()">–í–æ–π—Ç–∏</button>
  </div>
</section>

<!-- READER -->
<section id="readerScreen" class="screen">
  <header>
    <div>üìñ –ß–∏—Ç–∞–ª–∫–∞</div>
    <div>
      <button id="adminBtn" style="display:none" onclick="showAdmin()">–ê–¥–º–∏–Ω–∫–∞</button>
      <button onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>
  </header>
  <div class="content">
    <div id="pdf"></div>
  </div>
</section>

<!-- ADMIN -->
<section id="adminScreen" class="screen">
  <header>
    <div>‚öô –ê–¥–º–∏–Ω–∫–∞</div>
    <div>
      <button onclick="backToReader()">–ù–∞–∑–∞–¥</button>
      <button onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>
  </header>
  <div class="content" id="userList"></div>
</section>

<!-- ZOOM -->
<div class="zoom" id="zoom" style="display:none">
  <button onclick="zoomIn()">+</button>
  <button onclick="zoomOut()">‚àí</button>
</div>

<script>
/* firebase */
firebase.initializeApp({
  apiKey:"AIzaSyBI_MW2hD1k5ORHZF_56zVzJvelHSVnvko",
  authDomain:"book-aed2c.firebaseapp.com",
  projectId:"book-aed2c"
});
const auth=firebase.auth();
const db=firebase.firestore();

/* state */
let pdfDoc=null;
let SCALE=window.innerWidth<700?1.1:1.6;

/* helpers */
function isLandscape(){
  return window.innerWidth>window.innerHeight;
}

/* login */
function login(){
  auth.signInWithEmailAndPassword(email.value,password.value)
    .then(afterLogin)
    .catch(()=>alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞"));
}

async function afterLogin(){
  loginScreen.classList.remove("active");
  readerScreen.classList.add("active");
  zoom.style.display="block";

  const user=auth.currentUser;
  const ref=db.collection("users").doc(user.email);
  const snap=await ref.get();
  if(snap.exists && snap.data().role==="admin"){
    adminBtn.style.display="inline-block";
  }

  loadPDF();
}

/* logout */
function logout(){
  auth.signOut();
  location.reload();
}

/* screens */
function showAdmin(){
  readerScreen.classList.remove("active");
  adminScreen.classList.add("active");
  loadUsers();
}
function backToReader(){
  adminScreen.classList.remove("active");
  readerScreen.classList.add("active");
}

/* pdf */
function loadPDF(){
  pdfjsLib.getDocument("book.pdf").promise.then(pdf=>{
    pdfDoc=pdf;
    renderAll();
  });
}

function renderAll(){
  pdf.innerHTML="";
  if(!pdfDoc)return;

  /* 1Ô∏è‚É£ –û–ë–õ–û–ñ–ö–ê */
  renderPage(1,pdf,"cover");

  const mobile=window.innerWidth<700;
  const spreadMode=!mobile || isLandscape();

  if(spreadMode){
    for(let i=2;i<=pdfDoc.numPages;i+=2){
      const spread=document.createElement("div");
      spread.className="spread";
      renderPage(i,spread);
      if(i+1<=pdfDoc.numPages)renderPage(i+1,spread);
      pdf.appendChild(spread);
    }
  }else{
    for(let i=2;i<=pdfDoc.numPages;i++){
      renderPage(i,pdf);
    }
  }
}

function renderPage(num,container,cls){
  pdfDoc.getPage(num).then(page=>{
    const canvas=document.createElement("canvas");
    if(cls)canvas.className=cls;
    const ctx=canvas.getContext("2d");
    const dpr=window.devicePixelRatio||1;
    const vp=page.getViewport({scale:SCALE});
    canvas.width=vp.width*dpr;
    canvas.height=vp.height*dpr;
    canvas.style.width=vp.width+"px";
    canvas.style.height=vp.height+"px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
    page.render({canvasContext:ctx,viewport:vp});
    container.appendChild(canvas);
  });
}

/* zoom */
function zoomIn(){SCALE+=0.2;renderAll()}
function zoomOut(){SCALE=Math.max(.6,SCALE-.2);renderAll()}

/* admin */
async function loadUsers(){
  const snap=await db.collection("users").get();
  userList.innerHTML="";
  snap.forEach(d=>{
    userList.innerHTML+=`
      <div style="border:1px solid #333;padding:12px;border-radius:10px;margin-bottom:10px">
        <b>${d.id}</b>
      </div>`;
  });
}

/* orientation */
window.addEventListener("resize",()=>{
  renderAll();
});
</script>

</body>
</html>
